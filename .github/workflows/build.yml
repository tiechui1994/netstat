name: Build (manual - platform)

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'amd64'
        type: choice
        options:
          - amd64
          - arm64
          - arm7

jobs:
  build:
    name: Build for ${{ github.event.inputs.platform }}
    runs-on: ubuntu-latest
    env:
      PLATFORM: ${{ github.event.inputs.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cross toolchain
        run: |
          sudo apt-get update && sudo apt-get install -y wget tar upx
          if [ "$PLATFORM" = "amd64" ]; then
            sudo apt-get install -y build-essential
          elif [ "$PLATFORM" = "arm64" ]; then
            wget https://musl.cc/aarch64-linux-musl-cross.tgz
            sudo tar -xzf aarch64-linux-musl-cross.tgz -C /usr/local
            export PATH="/usr/local/aarch64-linux-musl-cross/bin:$PATH"
          else
            wget https://musl.cc/arm-linux-musleabi-cross.tgz
            sudo tar -xzf arm-linux-musleabi-cross.tgz -C /usr/local
            export PATH="/usr/local/arm-linux-musleabi-cross/bin:$PATH"
          fi

      - name: Build
        working-directory: src
        run: |
          make clean || true
          if [ "$PLATFORM" = "amd64" ]; then
            make amd64
          elif [ "$PLATFORM" = "arm64" ]; then
            make arm64 && upx build/traffic_monitor_arm64
          else
            make arm7 && upx build/traffic_monitor_arm7
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ env.PLATFORM }}
          path: src/build/
