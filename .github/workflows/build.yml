name: Build (manual - platform)

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'amd64'
        type: choice
        options:
          - amd64
          - arm64
          - arm7

jobs:
  build:
    name: Build for ${{ github.event.inputs.platform }}
    runs-on: ubuntu-latest
    env:
      PLATFORM: ${{ github.event.inputs.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cross toolchain
        run: |
          sudo apt-get update
          if [ "$PLATFORM" = "amd64" ]; then
            sudo apt-get install -y build-essential
          elif [ "$PLATFORM" = "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
          else
            sudo apt-get install -y gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi
          fi

      - name: Build
        working-directory: src
        run: |
          make clean || true
          if [ "$PLATFORM" = "amd64" ]; then
            make amd64
          elif [ "$PLATFORM" = "arm64" ]; then
            make arm64
          else
            make arm7
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ env.PLATFORM }}
          path: src/build/
